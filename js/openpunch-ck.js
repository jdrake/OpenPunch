function _OpenPunch(e,t){var n={env:e,os:t,hashes:{sessionId:"openpunch:sessionId"},roles:[{value:"participant",label:"Participants",active:!0},{value:"tutor",label:"Tutors",active:!0},{value:"parent",label:"Parents",active:!0},{value:"guest",label:"Guests",active:!0}]},r={dev:"http://127.0.0.1:5000/api/",network:"http://192.168.0.102:5000/api/",staging:"http://dev.openpunchapp.com/api/",live:"https://openpunchapp.com/api/"};n.apiRoot=r[n.env];JSON.originalParse=JSON.parse;JSON.parse=function(e){if(e)return JSON.originalParse(e)};$.ajaxPrefilter(function(e,t,n){e.xhrFields={withCredentials:!0};n.setRequestHeader("X-Requested-With","XMLHttpRequest")});var i=Backbone.Model.extend({idAttribute:"_id",parse:function(e){var t;_.each(e,function(n,r){t=r.toLowerCase();_.string.endsWith(t,"id")&&_.isObject(n)?e[r]=n.$oid:_.string.startsWith(t,"dt")&&(e[r]=new XDate(n.$date))});return e}}),s=Backbone.Model.extend({idAttribute:"Id"}),o=i,u=Backbone.Collection.extend(),a=Backbone.Collection.extend({parse:function(e){return e.records}}),f=u,l=Backbone.View.extend({initialize:function(){_.bindAll(this,"updateSuccess","updateError")},attributes:function(){return{id:this.options.idPrefix+(this.model?this.model.id:this.cid),"class":this.options.idPrefix+"page page hide"}},template:function(){return _.template($("#"+this.options.idPrefix+"template").html())},events:{"click button[type=submit]":"commitForm",keyup:"commitFormOnEnter"},render:function(){this.$el.html(this.template()(_.extend(this.model.toJSON(),n.helpers)));this.$el.find(".form-container").prepend(this.form.render().el);return this},commitFormOnEnter:function(e){e.keyCode===13&&this.commitForm(e)},commitForm:function(e){e.preventDefault();var t=this.form.commit();t||this.model.save(this.form.model.toJSON(),{success:this.updateSuccess,error:this.updateError})},updateSuccess:function(){this.model.trigger("show:modal")},updateError:function(){console.log(arguments)}});n.helpers={eventTime:function(e){return(new XDate(e,!0)).addHours(-5).toString("h:mmtt")},eventDate:function(e){var t=new XDate(!0),n=new XDate(e,!0),r=t.getFullYear(),i=t.getMonth(),s=t.getDate(),o=n.getFullYear(),u=n.getMonth(),a=n.getDate(),f=t.diffDays(n);return f<2&&f>=0?a===s?"Today":"Tomorrow":f>-2&&f<=0?a===s?"Today":"Yesterday":n.addHours(-5).toString("ddd MMM d, yyyy")},eventTitle:function(e){return _.string.prune(e,25)},relativeTime:function(e){var t=new XDate(e,!0),n=new XDate(!0),r=t.diffHours(n),i=t.diffMinutes(n),s=t.diffSeconds(n);return r>12?t.addHours(-5).toString("MMM d '&middot' h:mm tt"):r>1?[Math.round(r),r>2?"hours":"hour","ago"].join(" "):i>1?[Math.round(i),i>2?"mins":"min","ago"].join(" "):s>1?[Math.round(s),s>2?"secs":"sec","ago"].join(" "):"just now"},datePickerFormats:{browser:{date:function(e){return(new XDate(e,!0)).addHours(-5).toString("yyyy-MM-dd")},time:function(e){return(new XDate(e,!0)).addHours(-5).toString("H:mm")},datetime:function(e){return(new XDate(e,!0)).addHours(-5).toString("yyyy-MM-dd HH:mm")}},ios:{date:function(e){return(new XDate(e,!0)).addHours(-5).toString("yyyy-MM-dd")},time:function(e){return(new XDate(e,!0)).addHours(-5).toString("HH:mm")},datetime:function(e){return(new XDate(e,!0)).toISOString()}},android:{date:function(e){return(new XDate(e,!0)).addHours(-5).toString("yyyy-MM-dd")},time:function(e){return(new XDate(e,!0)).addHours(-5).toString("HH:mm")},datetime:function(e){return(new XDate(e,!0)).toISOString()}}},totalHours:function(e){var t=Math.floor(e),n=Math.floor((e-t)*60);return _.string.sprintf("%s h %s m",t,n)},money:function(e){var t=parseFloat(e);return t>=0?_.string.sprintf("$%.2f",t):_.string.sprintf("-$%.2f",Math.abs(t))},simpleDate:function(e){return(new XDate(e,!0)).addHours(-5).toString("MMM d")}};n.Filter=Backbone.Model.extend({idAttribute:"value"});n.Filters=Backbone.Collection.extend({model:n.Filter,localStorage:new Backbone.LocalStorage("openpunch:filters")});n.FilterGroup=Backbone.Model.extend({activeValues:function(){return _.map(this.get("filters").where({active:!0}),function(e){return e.get("value")})},pass:function(e){return _.indexOf(this.activeValues(),e.get(this.get("attr")))!==-1},isActive:function(){return this.get("filters").any(function(e){return e.get("active")===!1})}});n.FilterGroupRoles=n.FilterGroup.extend({defaults:{filters:new n.Filters(n.roles),attr:"role"},initialize:function(){this.get("filters").each(this.syncFilter,this)},syncFilter:function(e){e.fetch({error:function(e,t){t==="Record not found"&&e.save()}})}});n.FilterToggleView=Backbone.View.extend({tagName:"button",attributes:function(){return{"data-toggle":"button","data-value":this.model.get("value"),"class":"filter-button btn btn-block "+(this.model.get("active")?"active btn-success":"")}},events:{click:"toggleFilter"},initialize:function(){_.bindAll(this,"toggleFilter");this.parent=this.options.parent},render:function(){this.$el.text(this.model.get("label"));return this},toggleFilter:function(e){this.model.save("active",!this.model.get("active"));this.$el.toggleClass("btn-success",this.model.get("active"))}});n.Transaction=o.extend({defaults:function(){return{amount:0,side:"c",type:"Subscription Refill"}},ledgerAmount:function(){return this.get("amount")*(this.get("side")==="c"?1:-1)},amountClass:function(){var e=this.ledgerAmount();return e>0?"plus":e<0?"minus":""},pastTransactions:function(){return this.collection.filter(function(e){return new XDate(e.get("dtAdd"),!0)<new XDate(this.get("dtAdd"),!0)&&e.get("contactId")===this.get("contactId")},this)},newBalance:function(){return _.reduce(this.pastTransactions(),function(e,t){return e+t.ledgerAmount()},this.ledgerAmount())},event:function(){return this.get("type")==="Event Fee"&&this.get("eventId")?n.events.get(this.get("eventId")):null}});n.Transactions=f.extend({model:n.Transaction,url:n.apiRoot+"transactions",comparator:function(e){return-1*(new XDate(e.get("dtAdd"),!0)).getTime()}});n.transactions=new n.Transactions;n.Contact=o.extend({defaults:{role:"participant",manager:{}},firstLast:function(){return this.get("first")+" "+this.get("last")},firstLastInitial:function(){return this.get("first")+" "+this.get("last")[0]+"."},actions:function(){return new n.Actions(n.actions.where({contactId:this.id}))},transactions:function(){return new n.Transactions(n.transactions.where({contactId:this.id}))},balance:function(){return this.transactions().reduce(function(e,t){return e+t.ledgerAmount()},0)},balanceClass:function(){var e=this.balance();return e>0?"plus":e<0?"minus":""},totalCheckIns:function(){return _.uniq(_.pluck(this.actions().where({status:"in"}),"eventId")).length},totalTime:function(){var e=this.actions().groupBy(function(e){return e.get("eventId")}),t=_.reduce(e,function(e,t){return t.length!==2?e:e+Math.abs((new XDate(t[1].get("dt"),!0)).diffHours(t[0].get("dt")))},0);return n.helpers.totalHours(t)}});n.Contacts=f.extend({model:n.Contact,url:n.apiRoot+"contacts",comparator:function(e){return e.get("first").toLowerCase()+" "+e.get("last").toLowerCase()}});n.contacts=new n.Contacts;n.Event=o.extend({defaults:{cost:5},parse:function(e){o.prototype.parse.call(this,e);e.attendees=new n.Attendees(e.attendees||[],{eventId:e._id});return e},allActions:function(){return new n.Actions(n.actions.filter(_.bind(function(e){return e.get("eventId")===this.id&&n.contacts.get(e.get("contactId"))},this)))},status:function(){var e=new XDate(this.get("dtStart"),!0),t=new XDate(this.get("dtEnd"),!0),n=new XDate(!0),r=e.diffMinutes(n),i=t.diffMinutes(n);return r<0&&i<0?"future":r>0&&i>0?"past":"live"},totalAttendees:function(){var e=this.allActions().where({status:"in"}),t=_.map(e,function(e){return e.get("contactId")}),n=_.uniq(t);return n.length},lastAttendeeName:function(){var e=this.allActions();if(e.length>0){var t=e.first().get("contactId"),r=n.contacts.get(t);if(r)return r.firstLast();console.error("No contact found with id ",t);return"?!"}return"-"}});n.Events=f.extend({model:n.Event,url:n.apiRoot+"events",defaults:function(){return{attendees:new n.Attendees}},comparator:function(e){return-(new XDate(e.get("dtStart"),!0)).getTime()}});n.events=new n.Events;n.Attendee=o.extend({urlRoot:n.apiRoot+"attendees",initialize:function(){_.bindAll(this,"updateStatus","updateStatusSuccess","chargeForEvent","chargeForEventSuccess")},actions:function(){return new n.Actions(n.actions.where({eventId:this.get("eventId"),contactId:this.get("contactId")}))},latestAction:function(){return this.actions().first()},status:function(){return this.latestAction()?this.latestAction().get("status"):null},isCheckedIn:function(){return this.status()==="in"},isCheckedOut:function(){return this.status()==="out"},updateStatus:function(){n.actions.create(_.extend(n.account.meta(),{eventId:this.get("eventId"),contactId:this.get("contactId"),status:this.isCheckedIn()?"out":"in"}),{wait:!0,success:this.chargeForEvent,error:this.updateStatusError})},updateStatusSuccess:function(){console.log("attendee status saved")},updateStatusError:function(e,t){console.error(e);alert("Could not update status")},chargeForEvent:function(e,t){var r=n.transactions.where({eventId:this.get("eventId"),contactId:this.get("contactId")});r.length===0&&n.transactions.create(_.extend(n.account.meta(),{eventId:this.get("eventId"),contactId:this.get("contactId"),type:"Event Fee",amount:n.events.get(this.get("eventId")).get("cost"),side:"d"}),{wait:!0,success:this.chargeForEventSuccess,error:this.chargeForEventError})},chargeForEventSuccess:function(e,t){console.log("event fee transaction success")},chargeForEventError:function(e,t){console.error(e)}});n.Attendees=f.extend({model:n.Attendee,url:n.apiRoot+"attendees",initialize:function(e,t){_.each(e,function(e){e.eventId=t.eventId})}});n.Action=o.extend();n.Actions=f.extend({model:n.Action,url:n.apiRoot+"actions",comparator:function(e){return-1*(new XDate(e.get("dt"),!0)).getTime()}});n.actions=new n.Actions;n.Account=o.extend({urlRoot:n.apiRoot+"account",meta:function(){return{accountId:this.id,sessionId:this.get("sessionId")}},loadData:function(){console.log("fetch all data");var e={data:this.meta(),success:function(e,t){console.log("coll fetch success")},error:function(e,t){console.error(t.responseText);n.router.navigate("account/sign-out",{trigger:!0})}};n.events.fetch(e);n.contacts.fetch(e);n.actions.fetch(e);n.transactions.fetch(e)},setSessionId:function(){this.get("sessionId")&&localStorage.setItem(n.hashes.sessionId,this.get("sessionId"))},getSessionId:function(){return localStorage.getItem(n.hashes.sessionId)},clearSessionId:function(){this.unset("sessionId",{silent:!0});localStorage.removeItem(n.hashes.sessionId)}});n.account=new n.Account;n.SignInSchema=Backbone.Model.extend({schema:{email:{title:"Email",validators:["required","email"],fieldClass:"signin-email",editorClass:"span12"},password:{title:"Password",type:"Password",validators:["required"],fieldClass:"signin-password",editorClass:"span12"}}});n.SignInView=l.extend({el:"#sign-in",initialize:function(){l.prototype.initialize.call(this);_.bindAll(this,"signInSuccess","signInError");this.form=new Backbone.Form({model:new n.SignInSchema,idPrefix:"signin-"})},render:function(){this.$el.find(".form-container").prepend(this.form.render().el);return this},commitForm:function(e){e.preventDefault();this.$el.find(".form-error").addClass("hide");var t=this.form.commit();if(!t){console.log(JSON.stringify(this.form.model.toJSON()));console.log(n.account.urlRoot);n.account.fetch({data:this.form.model.toJSON(),success:this.signInSuccess,error:this.signInError})}},signInSuccess:function(e){console.log("signInSuccess");e.setSessionId();n.router.navigate("loading",{trigger:!0})},signInError:function(e,t){console.log("signInError: "+JSON.stringify(t));this.$el.find(".form-error").text(t.responseText||"Could not sign in").removeClass("hide")}});n.AccountView=Backbone.View.extend({el:"#account",template:_.template($("#account-view-template").html()),initialize:function(){this.model=n.account},render:function(){this.$el.find("#content-account").html(this.template(this.model.toJSON()));return this}});n.LoadingView=Backbone.View.extend({el:"#loading",initialize:function(){this.numLoaded=0;this.numToLoad=4;n.events.on("reset",this.dataFetched,this);n.contacts.on("reset",this.dataFetched,this);n.actions.on("reset",this.dataFetched,this);n.transactions.on("reset",this.dataFetched,this)},dataReady:function(){return this.numLoaded===this.numToLoad},dataFetched:function(e){console.log("collection loaded");this.numLoaded=this.numLoaded+1;this.dataReady()&&n.router.navigate("events",{trigger:!0})}});n.EventsView=Backbone.View.extend({el:"#events",initialize:function(){_.bindAll(this,"renderEvent");n.events.on("reset",this.renderEvents,this);n.events.on("all",function(e){console.log("EventsView",e)},this)},render:function(){this.list=this.$el.find("#events-list").empty();this.renderEvents(n.events);return this},renderEvents:function(e,t){var r=e.groupBy(function(e){return n.helpers.eventDate(e.get("dtStart"))});_.each(r,_.bind(function(e,t,n){this.list.append('<li class="section-title"><h6>'+t+"</h6></li>");_.each(e,this.renderEvent)},this));this.$el.find(".list-placeholder").toggleClass("hide",e.length>0)},renderEvent:function(e){var t=new n.EventLiView({model:e});this.list.append(t.render().el)},showDeleteAlert:function(){this.$el.find(".delete-alert").removeClass("hide");_.delay(_.bind(function(){this.$el.find(".delete-alert").addClass("hide")},this),3e3)}});n.EventLiView=Backbone.View.extend({tagName:"li",template:_.template($("#event-li-view-template").html()),render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers)));return this}});n.EventView=Backbone.View.extend({className:"page event-page",attributes:function(){this.model||n.router.navigate("loading",{trigger:!0});return{id:"event-"+this.model.id}},template:_.template($("#event-view-template").html()),events:{"click .init-scan":"initScan"},initialize:function(){_.bindAll(this,"initScan","scanSuccess","scanError");n.actions.on("add",this.refresh,this)},helpers:function(){return{totalAttendees:this.model.totalAttendees(),lastAttendeeName:this.model.lastAttendeeName(),status:this.model.status()}},refresh:function(e){e.get("eventId")===this.model.id&&this.render()},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers,this.helpers())));return this},initScan:function(e){window.plugins.barcodeScanner?window.plugins.barcodeScanner.scan(this.scanSuccess,this.scanError):alert("Scanning from browser not supported")},scanSuccess:function(e){if(e.cancelled)return!1;this.toggleStatus(e.text);return!0},scanError:function(e){alert("scanning failed: "+e)},toggleStatus:function(e){var t=this.model.get("attendees").where({contactId:e});if(t.length>0){var r=t[0];r.updateStatus()}else{var i=n.contacts.get(e);i?this.model.get("attendees").create(_.extend(n.account.meta(),{contactId:e}),{wait:!0,success:function(e,t){e.updateStatus()},error:function(e,t){console.error(t);alert("Could not toggle status")}}):alert("Contact with that ID does not exist")}}});n.EventSchema=Backbone.Model.extend({schema:{name:{title:"Name",validators:["required"],fieldClass:"event-name",editorAttrs:{placeholder:"e.g. Volunteer Club"},editorClass:"span12"},dtStart:{title:"Start Date &amp; Time",dataType:"datetime",validators:["required"],fieldClass:"event-startdatetime",editorClass:"span12"},dtEnd:{title:"End Date &amp; Time",dataType:"datetime",validators:["required"],fieldClass:"event-enddatetime",editorClass:"span12"},cost:{title:"Cost",validators:["required"],fieldClass:"event-cost",editorClass:"span3 currency",template:"currency"},location:{title:"Location",fieldClass:"event-location",editorAttrs:{placeholder:"e.g. Chicago Ave."},help:"(optional)",editorClass:"span12"},facilitator:{title:"Facilitator",fieldClass:"event-facilitator",editorAttrs:{placeholder:"e.g. Tara Wickey"},help:"(optional)",editorClass:"span12"}}});n.EventSchemaDetail=Backbone.Model.extend({schema:{name:{title:"Name",validators:["required"],fieldClass:"event-name",editorAttrs:{placeholder:"e.g. Volunteer Club"},editorClass:"span12"},dtStart:{title:"Start Date",type:"DateTime",validators:["required"],fieldClass:"event-startdatetime",editorClass:"span12"},dtEnd:{title:"End Date",type:"DateTime",validators:["required"],fieldClass:"event-enddatetime",editorClass:"span12"},cost:{title:"Cost",validators:["required"],fieldClass:"event-cost",template:"currency",editorClass:"span3 currency"},location:{title:"Location",fieldClass:"event-location",editorAttrs:{placeholder:"e.g. Chicago Ave."},help:"(optional)",editorClass:"span12"},facilitator:{title:"Facilitator",fieldClass:"event-facilitator",editorAttrs:{placeholder:"e.g. Tara Wickey"},help:"(optional)",editorClass:"span12"}}});n.FormSubmitModalView=Backbone.View.extend({attributes:function(){return{id:this.options.idPrefix+"modal-"+this.model.id,"class":this.options.idPrefix+"modal modal"}},template:function(){return _.template($("#"+this.options.idPrefix+"modal-template").html())},events:{"click .dismiss":"dismiss"},initialize:function(){_.bindAll(this,"dismiss");this.model.on("show:modal",this.render,this)},render:function(){this.$el.html(this.template()({_id:this.model.id}));this.$el.modal();var e=$(window).scrollTop()+$(window).height()-this.$el.height()-20;this.$el.offset({top:e});return this},dismiss:function(e){this.$el.modal("hide")}});n.EventEditView=l.extend({initialize:function(){l.prototype.initialize.call(this);n.os==="ios"?this.form=new Backbone.Form({model:new n.EventSchema({_id:this.model.id,accountId:n.account.id,name:this.model.get("name"),dtStart:n.helpers.datePickerFormats[n.os].datetime(this.model.get("dtStart")),dtEnd:n.helpers.datePickerFormats[n.os].datetime(this.model.get("dtEnd")),cost:this.model.get("cost"),location:this.model.get("location"),facilitator:this.model.get("facilitator")}),idPrefix:"event-"}):this.form=new Backbone.Form({model:new n.EventSchemaDetail({_id:this.model.id,accountId:n.account.id,name:this.model.get("name"),dtStart:(new XDate(this.model.get("dtStart"),!0)).toDate(),dtEnd:(new XDate(this.model.get("dtEnd"),!0)).toDate(),cost:this.model.get("cost"),location:this.model.get("location"),facilitator:this.model.get("facilitator")}),idPrefix:"event-"});this.modal=new n.FormSubmitModalView({model:this.model,idPrefix:this.options.idPrefix})}});n.EventCreateView=l.extend({initialize:function(){_.bindAll(this,"eventCreateSuccess");this.model=new n.Event;this.form=new Backbone.Form({model:n.os==="ios"?new n.EventSchema(this.model.toJSON()):new n.EventSchemaDetail(this.model.toJSON()),idPrefix:"event-"})},commitForm:function(e){e.preventDefault();var t=this.form.commit();t||n.events.create(_.extend(n.account.meta(),this.form.model.toJSON()),{success:this.eventCreateSuccess,error:this.eventCreateError})},eventCreateSuccess:function(e){this.form.model.clear();this.form.model.set(n.Event.prototype.defaults);n.router.navigate("events/"+e.id,{trigger:!0})},eventCreateError:function(){console.log(arguments)}});n.EventContactsView=Backbone.View.extend({className:"page event-contacts-page hide",attributes:function(){this.model||n.router.navigate("loading",{trigger:!0});return{id:"event-contacts-"+this.model.id}},template:_.template($("#event-contacts-view-template").html()),initialize:function(){_.bindAll(this,"renderEventContact")},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers)));this.list=this.$el.find(".contact-list");n.contacts.each(this.renderEventContact);return this},renderEventContact:function(e){var t=this.model.get("attendees").where({contactId:e.id}),r=t.length>0?t[0]:new n.Attendee({contactId:e.id,eventId:this.model.id}),i=new n.EventContactLiView({model:e,event:this.model,attendee:r});this.list.append(i.render().el)}});n.EventContactLiView=Backbone.View.extend({tagName:"li",template:_.template($("#event-contact-view-template").html()),events:{click:"toggleStatus"},initialize:function(){_.bindAll(this,"statusIconClass","lastSeenDate","lastSeenLabelClass","toggleStatus");this.event=this.options.event;this.attendee=this.options.attendee;this.attendee.on("change",this.render,this);n.actions.on("add",this.render,this)},statusIconClass:function(){return this.attendee.isCheckedIn()?"icon-ok":this.attendee.isCheckedOut()?"icon-arrow-left":"icon-blank"},lastSeenDate:function(){return this.attendee.latestAction()?n.helpers.relativeTime(this.attendee.latestAction().get("dt")):null},lastSeenLabelClass:function(){return this.attendee.isCheckedIn()?"label-success":""},helpers:function(){return{statusIconClass:this.statusIconClass,lastSeenDate:this.lastSeenDate,lastSeenLabelClass:this.lastSeenLabelClass}},render:function(e){if(e)if(e.get("eventId")!==this.event.id||e.get("contactId")!==this.model.id)return;this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers,this.helpers(),{attendee:this.attendee.toJSON()})));return this},toggleStatus:function(e){e.preventDefault();this.attendee.actions().length>0?this.attendee.updateStatus():this.event.get("attendees").create(_.extend(n.account.meta(),this.attendee.toJSON()),{wait:!0,success:function(e,t){e.updateStatus()},error:function(){console.error(arguments);alert("Could not toggle status")}})}});n.EventHistoryView=Backbone.View.extend({className:"page event-history-page hide",attributes:function(){this.model||n.router.navigate("loading",{trigger:!0});return{id:"event-history-"+this.model.id}},template:_.template($("#event-history-view-template").html()),initialize:function(){_.bindAll(this,"renderEventAction")},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers)));this.list=this.$el.find(".action-list");this.model.allActions().each(this.renderEventAction);this.$el.find(".list-placeholder").toggleClass("hide",this.model.allActions().length>0);return this},renderEventAction:function(e){var t=new n.EventActionLiView({model:e});this.list.append(t.render().el)}});n.EventActionLiView=Backbone.View.extend({tagName:"li",template:_.template($("#event-action-view-template").html()),initialize:function(){_.bindAll(this,"timestamp","timestampLabelClass");this.model.set({contact:n.contacts.get(this.model.get("contactId")).toJSON()})},timestamp:function(){return n.helpers.relativeTime(this.model.get("dt"))},timestampLabelClass:function(){return this.model.get("status")==="in"?"label-success":"label-important"},helpers:function(){return{timestamp:this.timestamp,timestampLabelClass:this.timestampLabelClass}},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers,this.helpers())));return this}});n.ContactsView=Backbone.View.extend({el:"#contacts",events:{"click #filter-contacts":"toggleFilterDialog","click .filter-button-close":"closeFilters"},initialize:function(){_.bindAll(this,"renderContact");n.contacts.on("reset",this.renderContacts,this);this.rolesFilter=new n.FilterGroupRoles;this.rolesFilter.get("filters").on("change:active",this.toggleFilterNotification,this)},render:function(){this.list=this.$el.find(".contact-list").empty();this.filterContainer=this.$el.find(".filter-container").empty();this.rolesFilter.get("filters").each(this.renderFilter,this);this.toggleFilterNotification();this.renderContacts(n.contacts);return this},renderContacts:function(e,t){this.$el.find(".list-placeholder").toggleClass("hide",e.length>0);e.each(this.renderContact)},renderContact:function(e){var t=new n.ContactLiView({model:e,parent:this});this.list.append(t.render().el)},renderFilter:function(e){var t=new n.FilterToggleView({model:e,parent:this});this.filterContainer.append(t.render().el)},showDeleteAlert:function(){this.$el.find(".delete-alert").removeClass("hide");_.delay(_.bind(function(){this.$el.find(".delete-alert").addClass("hide")},this),3e3)},toggleFilterDialog:function(e){e.preventDefault();$(e.currentTarget).parent().toggleClass("open")},closeFilters:function(e){$(e.currentTarget).parents(".open").removeClass("open")},toggleFilterNotification:function(){this.$el.find("#filter-contacts").toggleClass("btn-warning",this.rolesFilter.isActive())}});n.ContactLiView=Backbone.View.extend({tagName:"li",template:_.template($("#contact-li-view-template").html()),initialize:function(){this.options.parent.rolesFilter.get("filters").on("change:active",this.updateFilter,this)},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers)));this.updateFilter();return this},updateFilter:function(){this.$el.toggleClass("hide",!this.options.parent.rolesFilter.pass(this.model))}});n.ContactView=Backbone.View.extend({className:"page contact-page",template:_.template($("#contact-view-template").html()),attributes:function(){return{id:"contact-"+this.model.id}},helpers:function(){return{firstLast:_.bind(this.model.firstLast,this.model),firstLastInitial:_.bind(this.model.firstLastInitial,this.model),totalCheckIns:_.bind(this.model.totalCheckIns,this.model),totalTime:_.bind(this.model.totalTime,this.model),balance:_.bind(this.model.balance,this.model),balanceClass:_.bind(this.model.balanceClass,this.model)}},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers,this.helpers())));return this}});n.ContactSchema=Backbone.Model.extend({schema:{first:{title:"First name",validators:["required"],fieldClass:"contact-first",editorAttrs:{placeholder:"e.g. Jane"},editorClass:"span12"},last:{title:"Last name",validators:["required"],fieldClass:"contact-last",editorAttrs:{placeholder:"e.g. Smith"},editorClass:"span12"},role:{title:"Role",type:"Select",options:_.pluck(n.roles,"value"),validators:["required"],fieldClass:"contact-role",editorClass:"span12"},managerName:{title:"Account Managers's Name",fieldClass:"contact-manager-name",editorClass:"span12"},managerPhone:{title:"Account Managers's Phone",fieldClass:"contact-manager-phone",editorClass:"span12",dataType:"tel"}}});n.EditContactView=l.extend({initialize:function(){l.prototype.initialize.call(this);var e=this.model.get("manager");e&&this.model.set({managerName:e.name,managerPhone:e.phone},{silent:!0});this.form=new Backbone.Form({model:new n.ContactSchema(this.model.toJSON()),idPrefix:"contact-"});this.modal=new n.FormSubmitModalView({model:this.model,idPrefix:this.options.idPrefix})}});n.ContactCreateView=l.extend({initialize:function(){_.bindAll(this,"contactCreateSuccess");this.model=new n.Contact;this.form=new Backbone.Form({model:new n.ContactSchema,idPrefix:"contact-"})},commitForm:function(e){e.preventDefault();var t=this.form.commit();t||n.contacts.create(_.extend(n.account.meta(),this.form.model.toJSON()),{success:this.contactCreateSuccess,error:this.contactCreateError})},contactCreateSuccess:function(e){n.router.navigate("contacts/"+e.id,{trigger:!0})},contactCreateError:function(){console.log(arguments)}});var c=function(e,t,n){var r={type:e,message:"must be a number"};if(_.isNaN(parseFloat(t)))return r},h=function(e,t,n){var r={type:e,message:"must be more than $0"};if(parseFloat(t)<=0)return r};n.TransactionSchema=Backbone.Model.extend({schema:{type:{title:"Transaction Type",type:"Select",options:["Subscription Refill","Adhoc Charge"],validators:["required"],fieldClass:"transaction-type",editorClass:"span12"},amount:{title:"Amount",validators:["required",_.bind(c,this,"amount"),_.bind(h,this,"amount")],fieldClass:"transaction-amount",editorClass:"span3 currency",template:"currency"},notes:{title:"Notes",type:"TextArea",help:"(optional)",fieldClass:"transaction-notes",editorClass:"span12"}}});n.TransactionCreateView=l.extend({initialize:function(){_.bindAll(this,"transactionCreateSuccess","transactionCreateError","changeSide");this.model=new n.Transaction({contactId:this.options.contactId});this.form=new Backbone.Form({model:new n.TransactionSchema({amount:0}),idPrefix:"transaction-"});this.form.on("type:change",this.changeSide)},changeSide:function(e,t){this.model.set({side:t.getValue()==="Adhoc Charge"?"d":"c"},{silent:!0})},commitForm:function(e){e.preventDefault();var t=this.form.commit();t||n.transactions.create(_.extend(n.account.meta(),this.options,this.model.toJSON(),this.form.model.toJSON()),{wait:!0,success:this.transactionCreateSuccess,error:this.transactionCreateError})},transactionCreateSuccess:function(e){this.form.model.clear();n.router.navigate("contacts/"+e.get("contactId")+"/transactions",{trigger:!0});n.router.renderedViews.ContactTransactionsView[e.get("contactId")].showAddAlert()},transactionCreateError:function(e,t){console.log(t.responseText);n.transactions.remove(n.transactions.getByCid(e.cid))}});n.ContactTransactionsView=Backbone.View.extend({className:"page contact-transactions-page hide",attributes:function(){this.model||n.router.navigate("loading",{trigger:!0});return{id:"contact-transactions-"+this.model.id}},template:_.template($("#contact-transactions-view-template").html()),initialize:function(){_.bindAll(this,"renderContactTransaction")},helpers:function(){return{firstLastInitial:_.bind(this.model.firstLastInitial,this.model)}},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers,this.helpers())));this.list=this.$el.find(".transaction-list");this.model.transactions().each(this.renderContactTransaction);this.$el.find(".list-placeholder").toggleClass("hide",this.model.transactions().length>0);return this},renderContactTransaction:function(e){var t=new n.ContactTransactionTrView({model:e});this.list.append(t.render().el)},showAddAlert:function(){this.$el.find(".add-alert").removeClass("hide");_.delay(_.bind(function(){this.$el.find(".add-alert").addClass("hide")},this),3e3)}});n.ContactTransactionTrView=Backbone.View.extend({tagName:"tr",template:_.template($("#contact-transaction-tr-view-template").html()),initialize:function(){},helpers:function(){return{ledgerAmount:_.bind(this.model.ledgerAmount,this.model),amountClass:_.bind(this.model.amountClass,this.model),newBalance:_.bind(this.model.newBalance,this.model)}},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers,this.helpers())));return this}});n.ContactHistoryView=Backbone.View.extend({className:"page contact-history-page hide",attributes:function(){this.model||n.router.navigate("loading",{trigger:!0});return{id:"contact-history-"+this.model.id}},template:_.template($("#contact-history-view-template").html()),initialize:function(){_.bindAll(this,"renderContactAction")},helpers:function(){return{firstLastInitial:_.bind(this.model.firstLastInitial,this.model)}},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers,this.helpers())));this.list=this.$el.find(".action-list");this.model.actions().each(this.renderContactAction);this.$el.find(".list-placeholder").toggleClass("hide",this.model.actions().length>0);return this},renderContactAction:function(e){var t=new n.ContactActionLiView({model:e});this.list.append(t.render().el)}});n.ContactActionLiView=Backbone.View.extend({tagName:"li",template:_.template($("#contact-action-view-template").html()),initialize:function(){_.bindAll(this,"timestamp");var e=n.events.get(this.model.get("eventId"));e?this.model.set({event:e.toJSON()}):this.template=!0},timestamp:function(){return n.helpers.relativeTime(this.model.get("dt"))},statusVerb:function(){return this.status==="in"?"into":"out of"},helpers:function(){return{timestamp:this.timestamp,statusVerb:this.statusVerb}},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),n.helpers,this.helpers())));return this}});n.Error404=Backbone.View.extend({el:"#error-404"});n.Workspace=Backbone.Router.extend({initialize:function(){},renderedViews:{SignInView:{},AccountView:{},LoadingView:{},EventsView:{},EventCreateView:{},EventView:{},EventEditView:{},EventHistoryView:{},EventContactsView:{},ContactsView:{},ContactCreateView:{},ContactView:{},EditContactView:{},TransactionCreateView:{},ContactTransactionsView:{},ContactHistoryView:{},Error404:{}},renderViews:function(e,t,r){r=r||{};_.each(t,_.bind(function(t){var i=new n[t](r);$("body").append(i.render().el);this.renderedViews[t][e]=i},this))},loadExistingPage:function(e,t){$(".page").addClass("hide");$(".leave-open").removeClass("open");this.renderedViews[t][e].render().$el.removeClass("hide")},routes:{"":"signIn",loading:"loading",account:"account","account/sign-in":"signIn","account/sign-out":"signOut",events:"events","events/new":"eventNew","events/:id":"eventDashboard","events/:id/dashboard":"eventDashboard","events/:id/edit":"eventEdit","events/:id/delete":"eventDelete","events/:id/history":"eventHistory","events/:id/contacts":"eventContacts",contacts:"contacts","contacts/new":"contactNew","contacts/:id":"contactDetails","contacts/:id/details":"contactDetails","contacts/:id/edit":"contactEdit","contacts/:id/delete":"contactDelete"
,"contacts/:id/transactions":"contactTransactions","contacts/:id/transactions/new":"transactionNew","contacts/:id/history":"contactHistory",404:"error404"},signIn:function(){console.log("account has sessionId?",n.account.has("sessionId"));if(n.account.has("sessionId")){console.log("account already fetched");n.router.navigate("loading",{trigger:!0})}else{var e=n.account.getSessionId();if(e){console.log("Fetch account using local session id");n.account.fetch({data:{sessionId:e},success:function(e,t){n.account.setSessionId();n.router.navigate("loading",{trigger:!0})},error:function(e,t){n.account.clearSessionId();console.log(t.responseText);n.router.navigate("account/sign-in",{trigger:!0})}})}else{console.log("No local session ID. Sign in");var t=0;$(".page").addClass("hide");if(_.has(this.renderedViews.SignInView,t))this.renderedViews.SignInView[t].$el.removeClass("hide");else{this.renderViews(t,["SignInView"]);this.renderedViews.SignInView[t].$el.removeClass("hide")}}}},signOut:function(){n.account.clear({silent:!0});n.events.reset([],{silent:!0});n.contacts.reset([],{silent:!0});n.actions.reset([],{silent:!0});n.transactions.reset([],{silent:!0});this.renderedViews.LoadingView[0].numLoaded=0;console.log("account cleared");n.account.clearSessionId();n.router.navigate("account/sign-in",{trigger:!0})},account:function(){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var e=0;$(".page").addClass("hide");if(_.has(this.renderedViews.AccountView,e))this.loadExistingPage(e,"AccountView");else{this.renderViews(e,["AccountView"]);this.renderedViews.AccountView[e].$el.removeClass("hide")}},loading:function(){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var e=0;$(".page").addClass("hide");if(_.has(this.renderedViews.LoadingView,e)){var t=this.renderedViews.LoadingView[e];if(t.dataReady())n.router.navigate("events",{trigger:!0});else{t.$el.removeClass("hide");n.account.loadData()}}else{this.renderViews(e,["LoadingView"]);this.renderedViews.LoadingView[e].$el.removeClass("hide");n.account.loadData()}},events:function(){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var e=0;$(".page").addClass("hide");if(_.has(this.renderedViews.EventsView,e))this.loadExistingPage(e,"EventsView");else{this.renderViews(e,["EventsView"]);this.renderedViews.EventsView[e].$el.removeClass("hide")}},eventNew:function(){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var e=0;$(".page").addClass("hide");if(_.has(this.renderedViews.EventCreateView,e))this.loadExistingPage(e,"EventCreateView");else{this.renderViews(e,["EventCreateView"],{idPrefix:"event-create-"});this.renderedViews.EventCreateView[e].$el.removeClass("hide")}},eventDashboard:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}$(".page").addClass("hide");if(_.has(this.renderedViews.EventView,e))this.loadExistingPage(e,"EventView");else{var t=n.events.get(e);if(!t)n.router.navigate("404",{trigger:!0});else{this.renderViews(e,["EventView","EventHistoryView","EventContactsView"],{model:t});this.renderViews(e,["EventEditView"],{model:t,idPrefix:"event-edit-"})}}},eventEdit:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}this.loadExistingPage(e,"EventEditView")},eventDelete:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var t=n.events.get(e);confirm('Delete "'+t.get("name")+"\"? This will also remove the event from each attendee's history.")&&t.destroy({headers:n.account.meta(),success:_.bind(function(){this.renderedViews.EventsView[0].showDeleteAlert();n.router.navigate("events",{trigger:!0})},this),error:function(e,n){console.error("Could not delete event:",t.get("name"),n);alert("Oops! Could not delete event.")}})},eventHistory:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}this.loadExistingPage(e,"EventHistoryView")},eventContacts:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}this.loadExistingPage(e,"EventContactsView")},contacts:function(){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var e=0;$(".page").addClass("hide");if(_.has(this.renderedViews.ContactsView,e))this.loadExistingPage(e,"ContactsView");else{this.renderViews(e,["ContactsView"]);this.renderedViews.ContactsView[e].$el.removeClass("hide")}},contactNew:function(){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var e=0;$(".page").addClass("hide");if(_.has(this.renderedViews.ContactCreateView,e))this.loadExistingPage(e,"ContactCreateView");else{this.renderViews(e,["ContactCreateView"],{idPrefix:"contact-create-"});this.renderedViews.ContactCreateView[e].$el.removeClass("hide")}},contactDetails:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}console.log(e);$(".page").addClass("hide");if(_.has(this.renderedViews.ContactView,e))this.loadExistingPage(e,"ContactView");else{var t=n.contacts.get(e);if(!t)n.router.navigate("404",{trigger:!0});else{this.renderViews(e,["ContactView","ContactTransactionsView","ContactHistoryView"],{model:t,idPrefix:"contact-"});this.renderViews(e,["EditContactView"],{model:t,idPrefix:"contact-edit-"});this.renderViews(e,["TransactionCreateView"],{contactId:e,idPrefix:"transaction-create-"})}}},contactEdit:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}this.loadExistingPage(e,"EditContactView")},contactDelete:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var t=n.contacts.get(e);confirm('Delete "'+t.firstLast()+"\"? This will also remove contact from each event's history.")&&t.destroy({headers:n.account.meta(),success:_.bind(function(){this.renderedViews.ContactsView[0].showDeleteAlert();n.router.navigate("contacts",{trigger:!0})},this),error:function(e,n){console.error("Could not delete contact:",t.firstLast(),n);alert("Oops! Could not delete contact.")}})},transactionNew:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var t=e,r="TransactionCreateView",i="transaction";$(".page").addClass("hide");if(_.has(this.renderedViews[r],t))this.loadExistingPage(t,r);else{this.renderViews(t,[r],{idPrefix:i+"-create-",contactId:e});this.renderedViews[r][t].$el.removeClass("hide")}},contactTransactions:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}this.loadExistingPage(e,"ContactTransactionsView")},contactHistory:function(e){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}this.loadExistingPage(e,"ContactHistoryView")},error404:function(){if(!n.account.has("sessionId")||!n.account.id){n.router.navigate("account/sign-in",{trigger:!0});return!1}var e=0;$(".page").addClass("hide");if(_.has(this.renderedViews.Error404,e))this.loadExistingPage(e,"Error404");else{this.renderViews(e,["Error404"]);this.renderedViews.Error404[e].$el.removeClass("hide")}}});n.router=new n.Workspace;Backbone.history.start();return n};